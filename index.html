<!DOCTYPE html>
<html lang="ja" data-theme="classic">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cote-OS v8.9</title>
  <link rel="icon" href="images/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<!-- タスクバー: 3分割フレックスゾーン。position:absoluteなし。-->
<header id="taskbar">

  <!-- 左: flex:1 -->
  <div id="tb-left">
    <span id="logo">COTE<span class="ac">OS</span></span>
    <span id="ver">v8.9</span>
    <nav id="breadcrumb" aria-label="パンくずリスト"></nav>
  </div>

  <!-- 中央: flex:0、常にクリック可能 -->
  <div id="tb-center">
    <button id="btn-prev" class="tb-btn" title="前月へ (Ctrl+Left)">&#171;&nbsp;前月</button>
    <div id="date-block">
      <span id="date-display" aria-live="polite">Year 1, Month 4</span>
      <span id="slot-chip">スロット 1</span>
    </div>
    <button id="btn-next" class="tb-btn" title="次月へ (Ctrl+Right)">次月&nbsp;&#187;</button>
  </div>

  <!-- 右: flex:1、ギアアコーディオン -->
  <div id="tb-right">
    <div id="gear-wrap">

      <!-- トレイ: .open時に左へスライド -->
      <div id="gear-tray" aria-hidden="true">

        <!-- テーマフライアウト -->
        <div id="theme-wrap" class="gt-item-wrap">
          <button id="btn-theme" class="gt-btn theme-btn" title="テーマ切替">テーマ</button>
          <div id="theme-flyout" class="gt-flyout" aria-hidden="true">
            <button class="tf-opt" data-theme="classic">Classic</button>
            <button class="tf-opt" data-theme="light">Light</button>
            <button class="tf-opt" data-theme="dark">Dark</button>
          </div>
        </div>

        <!-- 履歴 -->
        <button id="btn-history" class="gt-btn hist-btn" title="月次履歴">履歴</button>

        <!-- BGM -->
        <div id="bgm-hitbox" class="gt-item-wrap">
          <button id="btn-bgm" class="gt-btn bgm-btn" title="BGM ON/OFF" aria-label="BGM ON/OFF">♫</button>
          <div id="bgm-slider-wrap" aria-hidden="true">
            <div id="vol-fill-track">
              <div id="vol-fill-bar"></div>
            </div>
            <input type="range" id="bgm-volume" min="0" max="100" value="70"
                   orient="vertical" aria-label="音量" title="音量" />
          </div>
        </div>

        <span class="gt-div"></span>

        <!-- セーブボタン -->
        <button id="btn-save" class="gt-btn sl-btn" title="セーブ">セーブ</button>

      </div><!-- /gear-tray -->

      <!-- ギアトグル -->
      <button id="gear-btn" aria-label="設定メニュー" aria-expanded="false" title="設定">⚙</button>
    </div><!-- /gear-wrap -->

    <input type="file" id="file-pick" accept=".json,application/json,.bin,application/octet-stream"
           aria-hidden="true" tabindex="-1" />
  </div><!-- /tb-right -->

</header>

<main id="app"></main>

<!-- 標準モーダル (確認、プロフィール操作など) -->
<div id="modal-overlay" class="hidden" role="dialog" aria-modal="true">
  <div id="modal-box">
    <button id="modal-x" aria-label="閉じる">✕</button>
    <div id="modal-body"></div>
  </div>
</div>

<!-- セーブ/ロードモーダル — v8.7: ヘッダー右側にログインボタン -->
<div id="sl-overlay" class="hidden" role="dialog" aria-modal="true" aria-labelledby="sl-title">
  <div id="sl-box">
    <div id="sl-header">
      <span id="sl-title">セーブ／ロード</span>
      <!-- v8.6: クラウドログインボタン — セーブモーダルヘッダー右側 -->
      <button id="sl-btn-login" class="sl-login-btn" title="Googleアカウントでログインしてクラウド同期">
        <span class="sl-login-icon">☁</span>
        <span class="sl-login-lbl">ログイン</span>
      </button>
      <!-- v8.6: ログイン済みユーザー表示 (JS側で表示/非表示を切替) -->
      <div id="sl-user-info" class="sl-user-info hidden">
        <span class="sl-user-icon">●</span>
        <span id="sl-user-name" class="sl-user-name"></span>
        <button id="sl-btn-logout" class="sl-logout-btn" title="ログアウト">ログアウト</button>
      </div>
    </div>

    <div id="sl-slots" aria-label="データスロット"></div>

    <div id="sl-controls" aria-label="操作パネル">
      <!-- 行1: セーブ・書き出し・読み込み・削除 -->
      <button id="sl-btn-save"   class="sl-act ac">セーブ</button>
      <button id="sl-btn-export" class="sl-act io">書き出し</button>
      <button id="sl-btn-import" class="sl-act io">読み込み</button>
      <button id="sl-btn-delete" class="sl-act dn">削除</button>
      <!-- 行2: プレイ・新しくプレイ・[空]・戻る -->
      <button id="sl-btn-play"     class="sl-act gn">プレイ</button>
      <button id="sl-btn-new-play" class="sl-act gn sl-act-new"
              title="スロットを使わずゲストとして1,200名の新規データでプレイ">新しくプレイ</button>
      <span   class="sl-act-empty"></span>
      <button id="sl-btn-back"     class="sl-act">戻る</button>
    </div>
  </div>
</div>

<!-- v7.5: カスタムUI確認/アラートモーダル -->
<div id="uic-overlay" class="hidden" role="dialog" aria-modal="true" aria-labelledby="uic-title-el">
  <div id="uic-box">
    <div id="uic-header">
      <span id="uic-title-el" class="uic-title"></span>
    </div>
    <div id="uic-body" class="uic-body"></div>
    <div id="uic-actions" class="uic-actions">
      <button id="uic-btn-ok"     class="uic-btn uic-btn-ok">確認</button>
      <button id="uic-btn-cancel" class="uic-btn uic-btn-cancel">キャンセル</button>
    </div>
  </div>
</div>

<div id="toast" role="status" aria-live="polite"></div>

<!-- v8.7: Firebase SDK (モジュール) — fbAuth, fbDb, fbProviderをwindowに公開 -->
<script type="module">
  import { initializeApp }                    from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider,
           signInWithPopup, signOut,
           onAuthStateChanged }               from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import { getFirestore,
           doc, getDoc, setDoc }              from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:            "AIzaSyB2EF19a91VBSpfhg0H_zFSfCsnLX4Ogjs",
    authDomain:        "cote-os-project.firebaseapp.com",
    projectId:         "cote-os-project",
    storageBucket:     "cote-os-project.firebasestorage.app",
    messagingSenderId: "733486192547",
    appId:             "1:733486192547:web:d5ba8627a6f56ec09a2c16"
  };

  const app      = initializeApp(firebaseConfig);
  const auth     = getAuth(app);
  const db       = getFirestore(app);
  const provider = new GoogleAuthProvider();

  /* ── app.js (非モジュール) からwindow経由でアクセス可能にする ── */
  window.fbAuth            = auth;
  window.fbDb              = db;
  window.fbProvider        = provider;
  window.fbSignIn          = () => signInWithPopup(auth, provider);
  window.fbSignOut         = () => signOut(auth);
  window.fbDoc             = doc;
  window.fbGetDoc          = getDoc;
  window.fbSetDoc          = setDoc;
  window.fbOnAuthChanged   = (cb) => onAuthStateChanged(auth, cb);

  console.log("Firebase v8.7 initialized — Cote-OS Cloud Link ready.");
</script>

<!-- v8.9: protobufjs ランタイム -->
<script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.5/dist/protobuf.min.js"></script>
<!-- v8.9: GameSave スキーマをインライン定義 (proto_bundle.js は CommonJS 形式でブラウザ非対応のため)
     protobuf.min.js が window.$protobuf を定義した後にこのブロックが実行される。            -->
<script>
(function(){
  'use strict';
  if(typeof window.$protobuf==='undefined'){ console.error('[Cote-OS] protobufjs not loaded'); return; }
  var pb=$protobuf, R=pb.Reader, W=pb.Writer, U=pb.util;
  var $r=pb.roots['default']||( pb.roots['default']={} );

  /* ── Stats (field 1〜8: hp,mp,str,vit,dex,agi,int,luk) ── */
  $r.Stats=(function(){
    function S(p){if(p)for(var k=Object.keys(p),i=0;i<k.length;++i)if(p[k[i]]!=null)this[k[i]]=p[k[i]];}
    S.prototype.hp=0;S.prototype.mp=0;S.prototype.str=0;S.prototype.vit=0;
    S.prototype.dex=0;S.prototype.agi=0;S.prototype.int=0;S.prototype.luk=0;
    S.create=function(p){return new S(p);};
    S.encode=function(m,w){w=w||W.create();
      if(m.hp)  w.uint32(8).int32(m.hp);
      if(m.mp)  w.uint32(16).int32(m.mp);
      if(m.str) w.uint32(24).int32(m.str);
      if(m.vit) w.uint32(32).int32(m.vit);
      if(m.dex) w.uint32(40).int32(m.dex);
      if(m.agi) w.uint32(48).int32(m.agi);
      if(m.int) w.uint32(56).int32(m.int);
      if(m.luk) w.uint32(64).int32(m.luk);
      return w;};
    S.decode=function(r,l){r=r instanceof R?r:new R(r);
      var e=l==null?r.len:r.pos+l,m=new S();
      while(r.pos<e){var t=r.uint32();switch(t>>>3){
        case 1:m.hp=r.int32();break; case 2:m.mp=r.int32();break;
        case 3:m.str=r.int32();break; case 4:m.vit=r.int32();break;
        case 5:m.dex=r.int32();break; case 6:m.agi=r.int32();break;
        case 7:m.int=r.int32();break; case 8:m.luk=r.int32();break;
        default:r.skipType(t&7);}} return m;};
    return S;
  })();

  /* ── Student (fields 1〜8) ── */
  $r.Student=(function(){
    function St(p){this.traits=[];if(p)for(var k=Object.keys(p),i=0;i<k.length;++i)if(p[k[i]]!=null)this[k[i]]=p[k[i]];}
    St.prototype.id='';St.prototype.lastName='';St.prototype.firstName='';
    St.prototype.gender='';St.prototype.grade=0;St.prototype.classId=0;
    St.prototype.stats=null;St.prototype.traits=U.emptyArray;
    St.create=function(p){return new St(p);};
    St.encode=function(m,w){w=w||W.create();
      if(m.id)        w.uint32(10).string(m.id);
      if(m.lastName)  w.uint32(18).string(m.lastName);
      if(m.firstName) w.uint32(26).string(m.firstName);
      if(m.gender)    w.uint32(34).string(m.gender);
      if(m.grade)     w.uint32(40).int32(m.grade);
      if(m.classId)   w.uint32(48).int32(m.classId);
      if(m.stats)     $r.Stats.encode(m.stats,w.uint32(58).fork()).ldelim();
      if(m.traits&&m.traits.length)for(var i=0;i<m.traits.length;++i)w.uint32(66).string(m.traits[i]);
      return w;};
    St.decode=function(r,l){r=r instanceof R?r:new R(r);
      var e=l==null?r.len:r.pos+l,m=new St();
      while(r.pos<e){var t=r.uint32();switch(t>>>3){
        case 1:m.id=r.string();break; case 2:m.lastName=r.string();break;
        case 3:m.firstName=r.string();break; case 4:m.gender=r.string();break;
        case 5:m.grade=r.int32();break; case 6:m.classId=r.int32();break;
        case 7:m.stats=$r.Stats.decode(r,r.uint32());break;
        case 8:if(!m.traits||!m.traits.length)m.traits=[];m.traits.push(r.string());break;
        default:r.skipType(t&7);}} return m;};
    return St;
  })();

  /* ── GameSave (fields 1〜3) ── */
  $r.GameSave=(function(){
    function G(p){this.students=[];if(p)for(var k=Object.keys(p),i=0;i<k.length;++i)if(p[k[i]]!=null)this[k[i]]=p[k[i]];}
    G.prototype.version=0;G.prototype.timestamp=0;G.prototype.students=U.emptyArray;
    G.create=function(p){return new G(p);};
    G.encode=function(m,w){w=w||W.create();
      if(m.version)   w.uint32(13).float(m.version);
      if(m.timestamp) w.uint32(16).int64(m.timestamp);
      if(m.students&&m.students.length)for(var i=0;i<m.students.length;++i)$r.Student.encode(m.students[i],w.uint32(26).fork()).ldelim();
      return w;};
    G.decode=function(r,l){r=r instanceof R?r:new R(r);
      var e=l==null?r.len:r.pos+l,m=new G();
      while(r.pos<e){var t=r.uint32();switch(t>>>3){
        case 1:m.version=r.float();break; case 2:m.timestamp=r.int64();break;
        case 3:if(!m.students||!m.students.length)m.students=[];m.students.push($r.Student.decode(r,r.uint32()));break;
        default:r.skipType(t&7);}} return m;};
    return G;
  })();

  console.log('[Cote-OS v8.9] Protobuf GameSave schema OK — compression active');
})();
</script>

<script src="https://w.soundcloud.com/player/api.js"></script>
<script src="app.js"></script>

<iframe id="bgm-player" width="100%" height="300" scrolling="no" frameborder="no" allow="autoplay"
  src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/2272461698&color=%23ff5500&auto_play=false&hide_related=false&show_comments=false&show_user=false&show_reposts=false&show_teaser=false&visual=false"
  style="display: none;"></iframe>
</body>
</html>
